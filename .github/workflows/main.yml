on:
  schedule:
    - cron: 0 8 * * *  # æ¯å¤©ä¸Šåˆ8ç‚¹æ‰§è¡ŒVPSç»­è´¹
    - cron: 30 2 * * 0  # æ¯å‘¨æ—¥2ç‚¹åŠæ‰§è¡Œrepoä¿æ´»
  push:
  workflow_dispatch:

jobs:
  vps-renewal:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
      - run: sudo apt-get -qq update && sudo apt-get -yqq install --no-install-recommends ffmpeg fonts-noto-cjk
      - run: yarn add puppeteer node-fetch
      - run: node main.mjs
        env:
          ACCOUNTS: ${{ secrets.ACCOUNTS }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      - uses: actions/upload-artifact@v4
        with:
          path: recording.webm

  repo-keepalive:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '30 2 * * 0'
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
      - run: yarn add node-fetch
      - name: Setup Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
      - name: Create keepalive file
        run: |
          echo "# Repo Keepalive" > keepalive.md
          echo "Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> keepalive.md
          echo "This file is automatically updated to keep the repository active." >> keepalive.md
      - name: Commit and push changes
        run: |
          git add keepalive.md
          git commit -m "ğŸ¤– Auto update: Keep repository active [skip ci]" || exit 0
          git push
      - name: Send Telegram notification
        run: |
          node -e "
          import('node-fetch').then(({default: fetch}) => {
            const botToken = process.env.TELEGRAM_BOT_TOKEN;
            const chatId = process.env.TELEGRAM_CHAT_ID;
            if (botToken && chatId) {
              fetch(\`https://api.telegram.org/bot\${botToken}/sendMessage\`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  chat_id: chatId,
                  text: 'ğŸ”„ <b>Repoä¿æ´»å®Œæˆ</b>\\n\\nğŸ“… æ—¶é—´: ' + new Date().toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'}) + '\\nâœ… çŠ¶æ€: æˆåŠŸ\\n\\nğŸ’¡ ä»“åº“å·²æ›´æ–°ï¼Œä¿æŒæ´»è·ƒçŠ¶æ€',
                  parse_mode: 'HTML'
                })
              });
            }
          });
          "
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
